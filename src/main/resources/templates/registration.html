<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>User Registration</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 600px;
            margin-top: 50px;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .form-group label {
            font-weight: bold;
        }
        .form-group input {
            border-radius: 5px;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            border-radius: 5px;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #004085;
        }
        .text-center {
            margin-bottom: 20px;
        }
        .is-valid {
            border-color: #28a745 !important;
        }
        .is-invalid {
            border-color: #dc3545 !important;
        }
        .password-requirements {
            font-size: 0.85rem;
            margin-top: 0.5rem;
            padding-left: 1.5rem;
        }
        .requirement-item {
            margin: 0.2rem 0;
            color: #dc3545;
            font-weight: bold;
            transition: all 0.3s ease;
            opacity: 1;
            max-height: 50px;
            overflow: hidden;
        }
        .requirement-item.hidden {
            opacity: 0;
            max-height: 0;
            margin: 0;
        }
        .requirement-item i {
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="text-center">BankApp Register</h1>
    
    <div th:if="${error}" class="alert alert-danger mt-3">
        <p th:text="${error}"></p>
    </div>

    <form th:action="@{/register}" th:object="${userRegistrationDto}" method="post">
        <div class="form-group">
            <label for="firstname">First Name:</label>
            <input type="text" 
                   id="firstname" 
                   th:field="*{firstname}" 
                   class="form-control" 
                   th:classappend="${#fields.hasErrors('firstname')} ? 'is-invalid'" 
                   placeholder="Enter your first name"/>
            <div class="invalid-feedback" th:if="${#fields.hasErrors('firstname')}" th:errors="*{firstname}"></div>
        </div>

        <div class="form-group">
            <label for="lastname">Last Name:</label>
            <input type="text" 
                   id="lastname" 
                   th:field="*{lastname}" 
                   class="form-control"
                   th:classappend="${#fields.hasErrors('lastname')} ? 'is-invalid'"
                   placeholder="Enter your last name"/>
            <div class="invalid-feedback" th:if="${#fields.hasErrors('lastname')}" th:errors="*{lastname}"></div>
        </div>

        <div class="form-group">
            <label for="dateOfBirth">Date of Birth:</label>
            <input type="date" 
                   id="dateOfBirth" 
                   th:field="*{dateOfBirth}" 
                   class="form-control"
                   th:classappend="${#fields.hasErrors('dateOfBirth')} ? 'is-invalid'"/>
            <div class="invalid-feedback" th:if="${#fields.hasErrors('dateOfBirth')}" th:errors="*{dateOfBirth}"></div>
        </div>

        <div class="form-group">
            <label for="PESEL">PESEL Number:</label>
            <input type="text" 
                   id="PESEL" 
                   th:field="*{PESEL}" 
                   class="form-control"
                   th:classappend="${#fields.hasErrors('PESEL')} ? 'is-invalid'"
                   placeholder="Enter your PESEL number"/>
            <div class="invalid-feedback" th:if="${#fields.hasErrors('PESEL')}" th:errors="*{PESEL}"></div>
        </div>

        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" 
                   id="email" 
                   th:field="*{email}" 
                   class="form-control"
                   th:classappend="${#fields.hasErrors('email')} ? 'is-invalid'"
                   placeholder="Enter your email"/>
            <div class="invalid-feedback" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>
        </div>

        <div class="form-group">
            <label for="phoneNumber">Phone Number:</label>
            <input type="tel" 
                   id="phoneNumber" 
                   th:field="*{phoneNumber}" 
                   class="form-control"
                   th:classappend="${#fields.hasErrors('phoneNumber')} ? 'is-invalid'"
                   placeholder="Enter your phone number (e.g. +48123456789)"/>
            <div class="invalid-feedback" th:if="${#fields.hasErrors('phoneNumber')}" th:errors="*{phoneNumber}"></div>
        </div>

        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" 
                   id="password" 
                   th:field="*{password}" 
                   class="form-control"
                   th:classappend="${#fields.hasErrors('password')} ? 'is-invalid'"
                   placeholder="Enter your password"/>
            <div class="invalid-feedback" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></div>
            <ul class="password-requirements list-unstyled">
                <li class="requirement-item" id="length-check">
                    <i class="fas fa-times"></i>Minimum 8 characters
                </li>
                <li class="requirement-item" id="uppercase-check">
                    <i class="fas fa-times"></i>At least one uppercase letter
                </li>
                <li class="requirement-item" id="lowercase-check">
                    <i class="fas fa-times"></i>At least one lowercase letter
                </li>
                <li class="requirement-item" id="number-check">
                    <i class="fas fa-times"></i>At least one number
                </li>
                <li class="requirement-item" id="special-check">
                    <i class="fas fa-times"></i>At least one special character (@$!%*?&)
                </li>
            </ul>
        </div>

        <div class="form-group">
            <label for="confirmPassword">Confirm Password:</label>
            <input type="password" 
                   id="confirmPassword" 
                   th:field="*{confirmPassword}" 
                   class="form-control"
                   th:classappend="${#fields.hasErrors('confirmPassword')} ? 'is-invalid'"
                   placeholder="Confirm your password"/>
            <div class="invalid-feedback" th:if="${#fields.hasErrors('confirmPassword')}" th:errors="*{confirmPassword}"></div>
        </div>

        <div class="form-group text-center">
            <button type="submit" class="btn btn-primary">Register</button>
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
$(document).ready(function() {
    // Reset validation state on page load
    function resetValidationState() {
        $('input').removeClass('is-valid is-invalid');
    }

    function validateField(field, condition, errorMessage) {
        if (!condition) {
            field.removeClass('is-valid').addClass('is-invalid');
            field.siblings('.invalid-feedback').text(errorMessage);
            return false;
        } else {
            field.removeClass('is-invalid').addClass('is-valid');
            return true;
        }
    }

    // Validate firstname field: checks for non-empty and only allows Polish letters
    function validateName() {
        const firstname = $('#firstname').val();
        if (!validateField($('#firstname'), firstname.length >= 1, 'First name is required')) {
            return false;
        }
        const regex = /^[A-Za-zĄąĆćĘęŁłŃńÓóŚśŹźŻż]+$/;
        return validateField($('#firstname'), regex.test(firstname), 'First name must contain only letters');
    }

    // Validate lastname field: checks for non-empty and only allows Polish letters
    function validateLastname() {
        const lastname = $('#lastname').val();
        if (!validateField($('#lastname'), lastname.length >= 1, 'Last name is required')) {
            return false;
        }
        const regex = /^[A-Za-zĄąĆćĘęŁłŃńÓóŚśŹźŻż]+$/;
        return validateField($('#lastname'), regex.test(lastname), 'Last name must contain only letters');
    }

    // PESEL validation
    function validatePesel() {
        const pesel = $('#PESEL').val();
        const peselRegex = /^\d{11}$/;
        return validateField($('#PESEL'), peselRegex.test(pesel), 'PESEL must be exactly 11 digits');
    }

    // Email validation
    function validateEmail() {
        const email = $('#email').val();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return validateField($('#email'), emailRegex.test(email), 'Please enter a valid email address');
    }

    // Phone number validation
    function validatePhoneNumber() {
        const phoneNumber = $('#phoneNumber').val();
        const phoneRegex = /^(\+48\d{9}|0\d{9}|[1-9]\d{8})$/;
        const isValid = phoneRegex.test(phoneNumber);
        let errorMessage = 'Invalid phone number format. ';
        
        if (!isValid) {
            if (phoneNumber.startsWith('+') && !phoneNumber.startsWith('+48')) {
                errorMessage += 'Only +48 prefix is allowed.';
            } else if (phoneNumber.startsWith('0') && phoneNumber.length !== 10) {
                errorMessage += 'When starting with 0, number must be exactly 10 digits.';
            } else if (!phoneNumber.startsWith('+') && !phoneNumber.startsWith('0') && phoneNumber.length !== 9) {
                errorMessage += 'Number must be exactly 9 digits when not using prefix.';
            } else {
                errorMessage += 'Use +48XXXXXXXXX, 0XXXXXXXXX or XXXXXXXXX format.';
            }
        }
        
        return validateField($('#phoneNumber'), isValid, errorMessage);
    }

    // Password validation
    function updatePasswordRequirements(password) {
        const requirements = {
            'length-check': password.length >= 8,
            'uppercase-check': /[A-Z]/.test(password),
            'lowercase-check': /[a-z]/.test(password),
            'number-check': /[0-9]/.test(password),
            'special-check': /[@$!%*?&]/.test(password)
        };

        Object.entries(requirements).forEach(([id, isMet]) => {
            const element = $(`#${id}`);
            if (isMet) {
                element.addClass('hidden');
            } else {
                element.removeClass('hidden');
            }
        });

        return Object.values(requirements).every(Boolean);
    }

    function validatePassword() {
        const password = $('#password').val();
        return validateField($('#password'), 
            updatePasswordRequirements(password),
            'Please meet all password requirements'
        );
    }

    // Password confirmation validation
    function validateConfirmPassword() {
        const password = $('#password').val();
        const confirmPassword = $('#confirmPassword').val();
        return validateField($('#confirmPassword'), 
            confirmPassword === password && confirmPassword.length > 0, 
            'Passwords do not match'
        );
    }

    // Date of birth validation
    function validateDateOfBirth() {
        const dateOfBirth = new Date($('#dateOfBirth').val());
        const today = new Date();
        
        if (dateOfBirth > today) {
            return validateField($('#dateOfBirth'), false, 'Date of birth cannot be in the future');
        }
        
        let age = today.getFullYear() - dateOfBirth.getFullYear();
        const monthDiff = today.getMonth() - dateOfBirth.getMonth();
        
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dateOfBirth.getDate())) {
            age--;
        }

        if (age > 120) {
            return validateField($('#dateOfBirth'), false, 'Age cannot exceed 120 years');
        }
        
        if (age < 18) {
            return validateField($('#dateOfBirth'), false, 'You must be at least 18 years old');
        }
        
        return validateField($('#dateOfBirth'), true, '');
    }

    // Reset validation state on page load
    resetValidationState();

    // Form submission validation
    $('form').on('submit', function(e) {
        // Reset validation states before checking
        resetValidationState();

        // Validate all fields
        const isNameValid = validateName();
        const isLastnameValid = validateLastname();
        const isPeselValid = validatePesel();
        const isEmailValid = validateEmail();
        const isPhoneNumberValid = validatePhoneNumber();
        const isPasswordValid = validatePassword();
        const isConfirmPasswordValid = validateConfirmPassword();
        const isDateOfBirthValid = validateDateOfBirth();

        // If any validation fails, prevent form submission
        if (!isNameValid || !isLastnameValid || !isPeselValid || !isEmailValid || 
            !isPhoneNumberValid || !isPasswordValid || !isConfirmPasswordValid || !isDateOfBirthValid) {
            e.preventDefault();
            e.stopPropagation();
            
            // Mark all invalid fields
            if (!isNameValid) $('#firstname').addClass('is-invalid');
            if (!isLastnameValid) $('#lastname').addClass('is-invalid');
            if (!isPeselValid) $('#PESEL').addClass('is-invalid');
            if (!isEmailValid) $('#email').addClass('is-invalid');
            if (!isPhoneNumberValid) $('#phoneNumber').addClass('is-invalid');
            if (!isPasswordValid) $('#password').addClass('is-invalid');
            if (!isConfirmPasswordValid) $('#confirmPassword').addClass('is-invalid');
            if (!isDateOfBirthValid) $('#dateOfBirth').addClass('is-invalid');
        }
    });

    // Attach validation to input events
    $('#firstname').on('input', validateName);
    $('#lastname').on('input', validateLastname);
    $('#PESEL').on('input', validatePesel);
    $('#email').on('input', validateEmail);
    $('#phoneNumber').on('input', validatePhoneNumber);
    $('#password').on('input', function() {
        validatePassword();
        validateConfirmPassword();
        updatePasswordRequirements($(this).val());
    });
    $('#confirmPassword').on('input', validateConfirmPassword);
    $('#dateOfBirth').on('change', validateDateOfBirth);

    // Handle server-side validation errors
    if ($('.alert-danger').length > 0) {
        resetValidationState();
        $('.form-control').each(function() {
            if ($(this).siblings('.invalid-feedback').text()) {
                $(this).addClass('is-invalid');
            }
        });
    }
});
</script>
</body>
</html>